{% extends 'league/base.html' %}
{% load static %}
{% load custom_filters %}
{% load tz %}
{% block title %}Race Team Selection{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Race Details Header -->
    <div class="card">
        <div class="card-header text-center">
       
            <h2>{{ race.template.name }} - {{ race.template.date|date:"F j, Y" }}</h2>
            <p class="mb-0"><strong>Location:</strong> {{ race.template.location }} - {{ race.template.circuit }}</p>
            <p class="mt-2">
                <strong>Lineup Deadline:</strong> 
                {% timezone "America/New_York" %}
                    {{ lineup_deadline|date:"F j, Y, g:i A" }}
                {% endtimezone %} (ET)
            </p>
        </div>
    </div>
   
    
    <!-- Power Ups Section -->
    <div class="mt-5" id="mulligan-container" data-league-id="{{ league_id }}" data-team-id="{{ team_id }}">
        <h3>Power Ups <i id="infoIcon" class="info-icon" style="cursor: pointer; margin-left: 8px;" title="Click for more information">ℹ️</i></h3>
        
        
        <div id="infoPopup" class="info-popup" style="display: none;">
            <div class="popup-content">
                <h4>Power Ups Details</h4>
                <p><strong>Mulligan:</strong> Allows you to make adjustments to your lineup after the initial submission deadline and before the mulligan deadline (1 hour prior to quali). Activate it to get more flexibility with your team selection. This can be used once per half of the season.</p>
                <p><strong>Overdrive:</strong> Assigns a Tier 2 driver that you would like to get 3x points the entire race weekend. Choose wisely, as this can significantly impact your total score. You only can use this once per season</p>
                <button id="closeInfoPopup" class="btn btn-secondary">Close</button>
            </div>
        </div>
        <div  id="mulliganMessage" ></div>
        {% if team.mulligan_active %}
            <div class="alert alert-info">
                Mulligan in Use - You can adjust your lineup until the mulligan deadline.
            </div>
            
        {% endif %}
        {% if has_mulligan_available and is_mulligan_window_open %}
            <!-- Show the option to use the mulligan -->
            <button type="button" id="useMulliganBtn" class="btn btn-primary">Use Mulligan</button>
        {% elif has_mulligan_available and not is_mulligan_window_open %}
            <!-- Inform the user they must wait for the correct time window -->
            <p>Your mulligan will be available after the lineup deadline.</p>
        {% elif not has_mulligan_available %}
            <!-- Inform the user they've already used their mulligan -->
            <p>You’ve already used your mulligan for this half.</p>
        {% endif %}

        {% if has_overdrive_available  %}
            <!-- Show the option to use the overdrive -->
            <button type="button" id="useOverdriveBtn" class="btn btn-primary">Use Overdrive</button>
            <div id="overdriveDriverMessage"></div>
            {% if team.overdrive_active %}
                <div id="overdrive-driver-container">
                    <label for="overdriveDriverSelect">Select Overdrive Driver:</label>
                    <select id="overdriveDriverSelect">
                        <!-- Options populated dynamically -->
                    </select>
                    <button id="confirmOverdriveDriverBtn">Confirm Overdrive Driver</button>
                    
                
                </div>
            {% endif %}
        
        {% elif not has_overdrive_available %}
            <!-- Inform the user they've already used their overdrive -->
            <p>You’ve already used your overdrive for this season.</p>
        {% endif %}
    </div>

   
    <!-- Team Selection Display -->
    <div class="mt-4">
        {% if team_selection %}
        <h3>Your Team Selection for This Race</h3>
        <ul class="list-group mb-4">
            {% for driver in team_selection.drivers.all %}
                <li class="list-group-item">{{ driver.name }} - {{ driver.constructor.name }}</li>
            {% endfor %}
        </ul>

        {% if driver_points %}
        <h4>Driver Performance in Race Sessions</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Driver</th>
                    <th>Qualifying Points</th>
                    {% if has_sprint %}
                        <th>Sprint Points</th>
                    {% endif %}
                    <th>Race Points</th>
                    <th>Total Points</th>
                </tr>
            </thead>
            <tbody>
                {% for driver_info in driver_points %}
                <tr>
                    <td>{{ driver_info.driver.name }}</td>
                    <td>{{ driver_info.points_breakdown.Qualifying|default:0 }}</td>
                    {% if has_sprint %}
                        <td>{{ driver_info.points_breakdown.Sprint|default:0 }}</td>
                    {% endif %}
                    <td>{{ driver_info.points_breakdown.Race|default:0 }}</td>
                    <td><strong>{{ driver_info.points_breakdown|sum_points|floatformat:2 }}</strong></td>
                </tr>
                {% endfor %}

                <!-- Prediction Points Row -->
                {% if prediction_answer and prediction_answer.is_correct %}
                <tr>
                    <th colspan="{% if has_sprint %}4{% else %}3{% endif %}">Prediction Question Points</th>
                    <td><strong>{{ prediction_answer.points_earned|floatformat:2 }}</strong></td>
                </tr>
                {% endif %}

                <!-- Total Points Row -->
                <tr>
                    <th>Total Points</th>
                    <td>{{ total_qualifying_points }}</td>
                    {% if has_sprint %}
                        <td>{{ total_sprint_points }}</td>
                    {% endif %}
                    <td>{{ total_race_points }}</td>
                    <td><strong>{{ total_points_with_prediction|floatformat:2 }}</strong></td>
                </tr>
            </tbody>
        </table>
        {% endif %}
        {% else %}
        <div class="alert alert-warning" role="alert">
            <p>You have not made a selection for this race yet.</p>
        </div>
        {% endif %}
    </div>

    <!-- Combined Race Form Section -->
    <div class="mt-5">
        {% if not is_past_race %}
        <h3>Make or Update Your Selection</h3>
        <form method="post" id="raceForm" class="mt-3">
            {% csrf_token %}


            <!-- Prediction Question Section -->
           <!-- Prediction Question Section -->
            <!-- Prediction Question Section -->
            {% if prediction_question %}
            <h5>{{ prediction_question.question_text }}</h5>  <!-- Show question text as header -->

            <div class="form-group">
                {% for field in form %}
                    {% if field.name in prediction_question.options.keys or field.name == "prediction_answer" %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-warning">
                A prediction question has not been added yet. You can submit your Tier 1 and Tier 2 driver selections now.
                Please revisit this page later to update your lineup when the prediction question becomes available.
            </div>
            {% endif %}

            <!-- Tier 1 Driver Select with Prices -->
            <h4>Team Selection</h4>
            <div id="max-drivers-warning" class="text-danger mt-2"></div>
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            <div class="form-group">
                <label for="id_tier_1_driver"><strong>Select a Tier 1 Driver</strong></label>
                <select name="tier_1_driver" id="id_tier_1_driver" class="form-control" data-tier="1">
                    <option value="">Select a driver</option>
                    {% for driver in form.fields.tier_1_driver.queryset %}
                        {% with usage=tier_1_usage|get_item:driver.id %}
                        <option value="{{ driver.id }}" data-price="{{ driver.price }}"
                            {% if usage and usage >= 3 %}disabled{% endif %}
                            {% if driver.id == form.initial.tier_1_driver.id|default:None %}selected{% endif %}>
                            {{ driver.name }} - ${{ driver.price }}M
                            {% if usage and usage >= 3 %}(Unavailable){% endif %}
                        </option>
                        {% endwith %}
                    {% endfor %}
                </select>
            </div>

            <!-- Tier 2 Drivers Checkbox with Prices -->
            <div class="form-group mt-3">
                <label><strong>Select Tier 2 Drivers</strong></label>
                <div class="form-check">
                    {% for driver in form.fields.tier_2_drivers.queryset %}
                    <div class="form-check">
                        <input type="checkbox" name="tier_2_drivers" value="{{ driver.id }}" data-price="{{ driver.price }}"
                        class="form-check-input tier-2-driver" id="driver-{{ driver.id }}"
                        {% if driver.id in form.initial.tier_2_drivers %}checked{% endif %}>
                        <label class="form-check-label" for="driver-{{ driver.id }}">
                            {{ driver.name }} - ${{ driver.price }}M
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Submit Button -->
            <div class="mt-4">
                <button type="submit" id="submitBtn" class="btn btn-primary btn-block">Submit Selection</button>
            </div>
        </form>
        {% endif %}
    </div>

    
</div>


<script>
    const isAfterLineupDeadline = "{{ is_after_lineup_deadline|yesno:'true,false' }}" === "true";
    const isBeforeMulliganDeadline = "{{ is_before_mulligan_deadline|yesno:'true,false' }}" === "true";
</script>
<script src="{% static 'js/team_selection.js' %}?v={{ now|date:'U' }}"></script>
{% endblock %}